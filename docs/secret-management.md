# Secret Management with Backend Abstraction

This document explains the pluggable secret backend system used for managing Komodo authentication credentials.

## Overview

The `komodo_auth` role supports multiple secret management backends through an abstraction layer. You can choose your preferred secret manager without changing the core Komodo deployment logic.

## Supported Backends

### 1. Infisical (Default)

**Open-source secret management platform** with CLI and Ansible collection support.

#### Requirements

- `infisical` CLI installed separately ([installation guide](https://infisical.com/docs/cli/overview))
- `infisicalsdk` Python package (included in `requirements.txt`)
- `infisical.vault` Ansible collection (included in `ansible/requirements.yml`)
- Universal Auth credentials:
  ```bash
  export INFISICAL_UNIVERSAL_AUTH_CLIENT_ID="your-client-id"
  export INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET="your-client-secret"
  ```

#### Configuration

In `ansible/roles/komodo_auth/defaults/main.yml`:

```yaml
komodo_auth_secret_backend: "infisical"
komodo_auth_infisical_project_id: "7b832220-24c0-45bc-a5f1-ce9794a31259"
komodo_auth_infisical_env: "prod"
komodo_auth_infisical_path: "/komodo"
komodo_auth_infisical_key_name: "KOMODO_API_KEY"
komodo_auth_infisical_secret_name: "KOMODO_API_SECRET"
```

#### How It Works

- **Read operations**: Uses `infisical.vault.read_secrets` lookup plugin
- **Write operations**: Uses `infisical secrets set` CLI command
- **Check operations**: Attempts read with `allow_empty: true`, falls back to empty on failure

#### Required Secrets in Infisical

Create these in your Infisical project at `/komodo` path:

- `KOMODO_ADMIN_USERNAME` - Admin user login
- `KOMODO_ADMIN_PASSWORD` - Admin user password
- `KOMODO_API_KEY` - Auto-generated by playbook
- `KOMODO_API_SECRET` - Auto-generated by playbook

### 2. 1Password (Legacy)

**Enterprise password manager** with CLI support.

#### Requirements

- `op` CLI installed and authenticated
- 1Password vault "Homelab Ansible" with "Komodo" item

#### Configuration

In `ansible/roles/komodo_auth/defaults/main.yml`:

```yaml
komodo_auth_secret_backend: "1password"
komodo_auth_1password_vault: "Homelab Ansible"
komodo_auth_1password_item: "Komodo"
```

#### How It Works

- **Read operations**: `op item get --fields`
- **Write operations**: `op item edit`
- **Check operations**: Attempts read, returns empty on failure

### 3. Ansible Vault (Planned)

Future support for Ansible's built-in encryption system.

## Backend Selection

### Method 1: Role Defaults (Recommended)

Edit `ansible/roles/komodo_auth/defaults/main.yml`:

```yaml
komodo_auth_secret_backend: "infisical"
```

### Method 2: Inventory Override

Edit `ansible/inventory/all.yml`:

```yaml
all:
  vars:
    komodo_auth_secret_backend: "infisical"
```

### Method 3: Playbook Override

```bash
ansible-playbook playbooks/03_komodo_auth.yml -e komodo_auth_secret_backend=1password
```

## Credential Lookup Methods

The inventory supports 4 methods for reading credentials:

### Method 1: Infisical (Ansible Collection)

```yaml
komodo_auth_admin_username: "{{ lookup('infisical.vault.read_secrets',
  universal_auth_client_id=lookup('env', 'INFISICAL_UNIVERSAL_AUTH_CLIENT_ID'),
  universal_auth_client_secret=lookup('env', 'INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET'),
  project_id='7b832220-24c0-45bc-a5f1-ce9794a31259',
  env_slug='prod',
  path='/komodo',
  secret_name='KOMODO_ADMIN_USERNAME').value }}"
```

### Method 2: 1Password (CLI)

```yaml
komodo_auth_admin_username: "{{ lookup('community.general.onepassword',
  'Komodo', field='username', vault='Homelab Ansible') }}"
```

### Method 3: Environment Variables

```yaml
komodo_auth_admin_username: "{{ lookup('env', 'KOMODO_ADMIN_USERNAME') }}"
```

### Method 4: Ansible Vault (Recommended for Production)

```yaml
# In ansible/group_vars/all/vault.yml (encrypted)
vault_komodo_admin_username: "admin"
vault_komodo_admin_password: "secret"

# In ansible/inventory/all.yml
komodo_auth_admin_username: "{{ vault_komodo_admin_username }}"
```

## Backend Architecture

### Interface Contract

Each backend file (`ansible/roles/komodo_auth/tasks/backends/*.yml`) implements:

#### 1. Check Operation

**Triggered with**: `operation: "check"`

**Purpose**: Determine if credentials already exist

**Output**: Sets `komodo_auth_existing_api_key` fact:

```yaml
komodo_auth_existing_api_key:
  stdout: "existing-key-value" # or "" if not found
```

#### 2. Store Operation

**Triggered with**: `operation: "store"`

**Purpose**: Save generated API credentials

**Input Variables**:

- `komodo_auth_api_key` - Generated API key
- `komodo_auth_api_secret` - Generated API secret

**Verification**: Must read back credentials to confirm storage

### Task Flow

```
ansible/roles/komodo_auth/tasks/main.yml
│
├── 1. Check existing credentials
│   └── include_tasks: backends/{{ komodo_auth_secret_backend }}.yml
│       with operation: "check"
│
├── 2. Skip if exists (unless komodo_auth_force_recreate=true)
│
├── 3. Wait for Komodo Core readiness
│
├── 4. Test admin user login
│
├── 5. Create admin user (if doesn't exist)
│   └── include_tasks: create_admin_user.yml
│
├── 6. Login as admin
│
├── 7. Create/find service user
│   └── include_tasks: manage_service_user.yml
│
├── 8. Create API key for service user
│   └── include_tasks: create_api_key.yml
│
└── 9. Store credentials
    └── include_tasks: backends/{{ komodo_auth_secret_backend }}.yml
        with operation: "store"
```

## Usage Examples

### Initial Setup with Infisical

```bash
# 1. Set up Infisical authentication
export INFISICAL_UNIVERSAL_AUTH_CLIENT_ID="your-client-id"
export INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET="your-client-secret"

# 2. Create required secrets in Infisical
infisical secrets set KOMODO_ADMIN_USERNAME=admin \
  --projectId="7b832220-24c0-45bc-a5f1-ce9794a31259" \
  --env="prod" \
  --path="/komodo"

infisical secrets set KOMODO_ADMIN_PASSWORD=YourSecurePassword \
  --projectId="7b832220-24c0-45bc-a5f1-ce9794a31259" \
  --env="prod" \
  --path="/komodo"

# 3. Run the playbook (will auto-generate API keys)
cd ansible
ansible-playbook -i inventory/all.yml playbooks/03_komodo_auth.yml
```

### Force Recreation of API Keys

```bash
ansible-playbook playbooks/03_komodo_auth.yml -e komodo_auth_force_recreate=true
```

### Switch from 1Password to Infisical

```bash
# 1. Export credentials from 1Password
op item get "Komodo" --vault "Homelab Ansible" --format json > komodo-creds.json

# 2. Import to Infisical
infisical secrets set KOMODO_ADMIN_USERNAME=$(jq -r '.fields[] | select(.label=="username") | .value' komodo-creds.json) \
  --projectId="..." --env="prod" --path="/komodo"

infisical secrets set KOMODO_ADMIN_PASSWORD=$(jq -r '.fields[] | select(.label=="password") | .value' komodo-creds.json) \
  --projectId="..." --env="prod" --path="/komodo"

# 3. Update inventory to use Infisical lookups (uncomment Infisical section, comment 1Password)

# 4. Update backend in defaults
# Edit ansible/roles/komodo_auth/defaults/main.yml:
# komodo_auth_secret_backend: "infisical"

# 5. Run with force recreation
ansible-playbook playbooks/03_komodo_auth.yml -e komodo_auth_force_recreate=true

# 6. Clean up
rm komodo-creds.json
```

## Troubleshooting

### Issue: "API keys already exist" but deployment is fresh

**Cause**: Stale credentials from previous Komodo instance exist in secret backend

**Solution**:

```bash
# Option 1: Force recreation
ansible-playbook playbooks/03_komodo_auth.yml -e komodo_auth_force_recreate=true

# Option 2: Manually delete from backend
# For Infisical:
infisical secrets delete KOMODO_API_KEY --projectId="..." --env="prod" --path="/komodo"
infisical secrets delete KOMODO_API_SECRET --projectId="..." --env="prod" --path="/komodo"

# For 1Password:
op item edit "Komodo" --vault "Homelab Ansible" komodo_api_key=""
```

### Issue: Infisical authentication failure

**Symptom**:

```
❌ Missing Infisical authentication credentials!
```

**Solution**:

```bash
# Verify environment variables are set
echo $INFISICAL_UNIVERSAL_AUTH_CLIENT_ID
echo $INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET

# If empty, set them:
export INFISICAL_UNIVERSAL_AUTH_CLIENT_ID="your-client-id"
export INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET="your-client-secret"

# Or add to .env file and source it
```

### Issue: Downstream playbooks fail with API errors

**Cause**: API credentials not properly synced to inventory lookups

**Solution**:

```bash
# Verify credentials exist in backend
infisical secrets get KOMODO_API_KEY --projectId="..." --env="prod" --path="/komodo"

# Test lookup manually
ansible localhost -m debug -a "msg={{ lookup('infisical.vault.read_secrets', ...).value }}"

# If missing, force recreation
ansible-playbook playbooks/03_komodo_auth.yml -e komodo_auth_force_recreate=true
```

### Issue: Backend file not found

**Symptom**:

```
ERROR! Unable to retrieve file contents
Could not find or access 'backends/custom-backend.yml'
```

**Solution**:

```bash
# Verify backend exists
ls ansible/roles/komodo_auth/tasks/backends/

# Check backend name matches exactly
grep komodo_auth_secret_backend ansible/roles/komodo_auth/defaults/main.yml

# Available backends:
# - infisical
# - 1password
```

## Adding a New Backend

To add a new secret backend (e.g., HashiCorp Vault):

### 1. Create Backend File

Create `ansible/roles/komodo_auth/tasks/backends/vault.yml`:

```yaml
---
# HashiCorp Vault Secret Backend Implementation

- name: "[Vault] Check if API keys already exist"
  ansible.builtin.shell: |
    vault kv get -field=api_key secret/komodo 2>/dev/null || echo ""
  register: komodo_auth_existing_api_key
  failed_when: false
  changed_when: false
  no_log: true
  when: operation == 'check'

- name: "[Vault] Store API key"
  ansible.builtin.shell: |
    vault kv put secret/komodo api_key="{{ komodo_auth_api_key }}"
  no_log: true
  changed_when: true
  when: operation == 'store'

- name: "[Vault] Store API secret"
  ansible.builtin.shell: |
    vault kv put secret/komodo api_secret="{{ komodo_auth_api_secret }}"
  no_log: true
  changed_when: true
  when: operation == 'store'

- name: "[Vault] Verify stored credentials"
  ansible.builtin.shell: |
    vault kv get -field=api_key secret/komodo
  register: komodo_auth_verify_api_key
  changed_when: false
  no_log: true
  when: operation == 'store'
```

### 2. Add Configuration Defaults

In `ansible/roles/komodo_auth/defaults/main.yml`:

```yaml
# HashiCorp Vault Backend Settings
komodo_auth_vault_addr: "http://vault.example.com:8200"
komodo_auth_vault_token: "{{ lookup('env', 'VAULT_TOKEN') }}"
komodo_auth_vault_path: "secret/komodo"
```

### 3. Update Inventory

In `ansible/inventory/all.yml`:

```yaml
# Method 5: HashiCorp Vault
komodo_auth_admin_username: "{{ lookup('community.hashi_vault.vault_kv2_get',
  'secret/komodo',
  engine_mount_point='kv').secret.username }}"
```

### 4. Test

```bash
# Set backend
export KOMODO_AUTH_SECRET_BACKEND=vault

# Run playbook
ansible-playbook playbooks/03_komodo_auth.yml -e komodo_auth_secret_backend=vault
```

## Security Best Practices

### 1. Environment Variables

✅ **Good**: Store in `.env` files outside repository

```bash
# .env (add to .gitignore)
INFISICAL_UNIVERSAL_AUTH_CLIENT_ID=abc123
INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET=xyz789
```

❌ **Bad**: Hardcode in inventory

```yaml
# Don't do this!
komodo_auth_infisical_client_id: "abc123"
```

### 2. Ansible Vault

✅ **Good**: Encrypt sensitive group_vars

```bash
ansible-vault create ansible/group_vars/all/vault.yml
ansible-vault edit ansible/group_vars/all/vault.yml
```

### 3. Secret Rotation

Regularly rotate API keys:

```bash
# Force new API key generation
ansible-playbook playbooks/03_komodo_auth.yml -e komodo_auth_force_recreate=true
```

### 4. Least Privilege

- Use dedicated service users (not admin) for automation
- Create separate API keys for different purposes
- Limit secret backend access to necessary projects/paths

## Related Files

- `ansible/roles/komodo_auth/README.md` - Role documentation
- `ansible/roles/komodo_auth/defaults/main.yml` - Backend configuration
- `ansible/roles/komodo_auth/tasks/backends/` - Backend implementations
- `ansible/tasks/infisical-secret-lookup.yml` - Reusable Infisical lookup task
- `requirements.txt` - Python dependencies (includes `infisicalsdk`)
- `ansible/requirements.yml` - Ansible collections (includes `infisical.vault`)

## See Also

- [Infisical Documentation](https://infisical.com/docs)
- [1Password CLI Documentation](https://developer.1password.com/docs/cli)
- [Ansible Vault Guide](https://docs.ansible.com/ansible/latest/vault_guide/vault.html)
- [Deployment Runbook](deployment-runbook.md)
